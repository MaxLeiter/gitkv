import e from"fs";import t,{resolve as r,dirname as i,extname as n,join as s}from"path";import{createFilter as o}from"@rollup/pluginutils";import{transform as l,minify as a}from"@swc/core";import c from"@fastify/deepmerge";import{parseTsconfig as u,getTsconfig as m}from"get-tsconfig";export{default as preserveUseDirective}from"rollup-preserve-directives";let f=new Map,d=(e,r,i)=>{var n,s,o;let l=`${r}:${null!=i?i:"undefined"}`;if(f.has(l))return null!==(n=f.get(l))&&void 0!==n?n:{};if(i&&t.isAbsolute(i)){let e=null!==(s=u(i).compilerOptions)&&void 0!==s?s:{},r=t.dirname(i);return null!=e.paths&&(e.baseUrl=null!=e.baseUrl?t.resolve(r,e.baseUrl):r),f.set(l,e),e}let a=m(r,i||"tsconfig.json");a||i||(e.warn({message:"Can't find tsconfig.json, trying jsconfig.json now",pluginCode:"SWC_TSCONFIG_NOT_EXISTS"}),a=m(r,"jsconfig.json"));let c=null!==(o=null==a?void 0:a.config.compilerOptions)&&void 0!==o?o:{};if(null!=c.paths&&(null==a?void 0:a.path)){let e=t.dirname(a.path);c.baseUrl=null!=c.baseUrl?t.resolve(e,c.baseUrl):e}return f.set(l,c),c},p=/\.[cm]?[jt]sx?$/,v=/node_modules/,x=[".ts",".tsx",".mjs",".js",".cjs",".jsx"],j=c({all:!0,mergeArray:e=>(t,r)=>e.clone(r)}),g=t=>e.promises.access(t,e.constants.F_OK).then(()=>!0).catch(()=>!1);function y(t={}){let c=o(t.include||p,t.exclude||v),u=t.extensions||x,m=async(e,t=!1)=>{let r=e.replace(p,"");for(let i of u){let n=t?s(e,`index${i}`):`${r}${i}`;if(await g(n))return n}return null};return{name:"swc",async resolveId(t,n){if(t.startsWith("\x00")||!c(n))return null;if(n&&"."===t[0]){let s=r(n?i(n):process.cwd(),t),o=await m(s);if(o||!o&&await g(s)&&(await e.promises.stat(s)).isDirectory()&&(o=await m(s,!0)))return o}},async transform(e,r){var s;if(!c(r))return null;let o=n(r);if(!u.includes(o))return null;let a=".ts"===o||".mts"===o||".cts"===o||".tsx"===o,m=!1===t.tsconfig?{}:d(this,i(r),t.tsconfig),f="react-jsx"===m.jsx||"react-jsxdev"===m.jsx,p={jsc:{externalHelpers:m.importHelpers,parser:{syntax:a?"typescript":"ecmascript",[a?"tsx":"jsx"]:a?".tsx"===o:".jsx"===o,decorators:m.experimentalDecorators},transform:{decoratorMetadata:m.emitDecoratorMetadata,react:{runtime:f?"automatic":"classic",importSource:m.jsxImportSource,pragma:m.jsxFactory,pragmaFrag:m.jsxFragmentFactory,development:"react-jsxdev"===m.jsx||void 0}},target:null===(s=m.target)||void 0===s?void 0:s.toLowerCase(),baseUrl:m.baseUrl,paths:m.paths}},{filename:v,include:x,exclude:g,tsconfig:y,extensions:w,minify:h,...b}=t;return l(e,j(p,b,{jsc:{minify:void 0},filename:r,minify:!1}))},renderChunk(e){var r,i,n,s,o;return t.minify||(null===(i=t.jsc)||void 0===i?void 0:null===(r=i.minify)||void 0===r?void 0:r.mangle)||(null===(s=t.jsc)||void 0===s?void 0:null===(n=s.minify)||void 0===n?void 0:n.compress)?a(e,{...null===(o=t.jsc)||void 0===o?void 0:o.minify,module:!0}):null}}}function w(e={}){return{name:"swc-minify",renderChunk:t=>a(t,e)}}function h(e){return e}function b(e){return e}export{y as default,b as defineRollupSwcMinifyOption,h as defineRollupSwcOption,w as minify,y as swc};
